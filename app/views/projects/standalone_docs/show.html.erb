<div class="container mx-auto px-4 py-8" data-controller="doc-links">
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-slate-900"><%= @doc.title %></h1>
        <div class="flex items-center gap-3 mt-3">
          <%= render StatusBadgeComponent.new(status: @doc.doc_type, type: :status) %>
        </div>
      </div>
      <div class="flex gap-2">
        <%= render EditButtonComponent.new(path: edit_projects_doc_path(@doc)) %>
        <%= render DeleteButtonComponent.new(path: projects_doc_path(@doc)) %>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <div class="markdown-content">
      <%= render_markdown(@doc.content).html_safe %>
    </div>
  </div>

  <!-- Projects using this doc -->
  <% if @doc.projects.any? %>
    <div class="bg-white rounded-lg shadow mb-8">
      <div class="p-6 border-b border-slate-200">
        <h2 class="text-xl font-semibold text-slate-900">Used in Projects</h2>
      </div>
      <div class="p-6">
        <div class="space-y-2">
          <% @doc.projects.each do |project| %>
            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-md hover:bg-slate-100 transition">
              <div>
                <%= link_to project.name, projects_project_path(project), class: "font-medium text-blue-600 hover:text-blue-800" %>
                <p class="text-sm text-slate-600"><%= project.summary %></p>
              </div>
              <%= render StatusBadgeComponent.new(status: project.status, type: :status) %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Links Section -->
  <div class="bg-white rounded-lg shadow">
    <div class="p-6 border-b border-slate-200">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-slate-900"><%= t('projects.links.title') %></h2>
        <button type="button" data-action="click->doc-links#toggleForm" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors">
          <%= t('projects.links.add_existing') %>
        </button>
      </div>
    </div>

    <!-- Add Existing Link Form -->
    <div data-doc-links-target="form" class="hidden p-6 border-b border-slate-200 bg-slate-50">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2"><%= t('projects.links.search_link') %></label>
          <input 
            type="text" 
            data-doc-links-target="search"
            data-action="input->doc-links#filterLinks"
            placeholder="<%= t('projects.links.search_placeholder') %>"
            class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" 
          />
        </div>
        
        <div class="max-h-64 overflow-y-auto border border-slate-200 rounded-md bg-white">
          <% if Projects::Link.for_account(Current.account).any? %>
            <% Projects::Link.for_account(Current.account).order(:title).each do |link| %>
              <%= form_with url: projects_doc_doc_links_path(@doc), method: :post, local: true, class: "border-b border-slate-100 last:border-0" do |f| %>
                <%= f.hidden_field :link_id, value: link.id %>
                <button 
                  type="submit"
                  data-doc-links-target="linkItem"
                  data-link-title="<%= link.title.downcase %>"
                  data-link-url="<%= link.url.downcase %>"
                  class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors focus:bg-slate-100 focus:outline-none"
                >
                  <div class="font-medium text-slate-900"><%= link.title %></div>
                  <div class="text-xs text-slate-500 truncate"><%= link.url %></div>
                  <div class="text-xs text-slate-400 mt-1"><%= t("projects.link_types.#{link.link_type}") %></div>
                </button>
              <% end %>
            <% end %>
          <% else %>
            <div class="p-4 text-sm text-slate-500 text-center">
              <%= t('projects.links.no_available_links') %>
            </div>
          <% end %>
        </div>
        
        <button type="button" data-action="click->doc-links#toggleForm" class="inline-flex items-center px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium rounded-md border border-slate-300 transition-colors">
          <%= t('shared.cancel') %>
        </button>
      </div>
    </div>

    <!-- Links List -->
    <div class="p-6">
      <% if @doc.links.any? %>
        <div class="space-y-2">
          <% @doc.links.each do |link| %>
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-md hover:bg-slate-100 transition-colors">
              <div class="flex-1 min-w-0">
                <h3 class="text-sm font-semibold text-slate-900 truncate"><%= link.title %></h3>
                <a href="<%= link.url %>" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:text-blue-800 truncate block">
                  <%= link.url %>
                </a>
                <p class="text-xs text-slate-500 mt-1"><%= t("projects.link_types.#{link.link_type}") %></p>
              </div>
              <div class="flex items-center gap-2 ml-4">
                <%= link_to projects_link_path(link), class: "inline-flex items-center px-3 py-1.5 bg-white hover:bg-slate-50 text-slate-700 text-xs font-medium rounded border border-slate-300 transition-colors" do %>
                  <%= t('shared.view') %>
                <% end %>
                <%= button_to projects_doc_doc_link_path(@doc, link), 
                             method: :delete, 
                             data: { turbo_confirm: t('shared.confirm_destroy') },
                             class: "inline-flex items-center px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-700 text-xs font-medium rounded border border-red-200 transition-colors" do %>
                  <%= t('account_memberships.remove') %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-slate-500 text-center py-8"><%= t('projects.links.no_links') %></p>
      <% end %>
    </div>

    <!-- Create New Link -->
    <div class="p-6 border-t border-slate-200 bg-slate-50">
      <%= link_to t('projects.links.create_new'), new_projects_link_path(return_to_doc_id: @doc.id), class: "inline-flex items-center px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium rounded-md border border-slate-300 transition-colors" %>
    </div>
  </div>

  <div class="mt-8">
    <%= link_to "â† Back to Documents", projects_docs_path, class: "text-blue-600 hover:text-blue-800 font-medium" %>
  </div>
</div>
