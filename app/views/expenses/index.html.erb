<p style="color: green"><%= notice %></p>

<% content_for :title, t("expenses.index.title") %>

<% ordered_expenses = @expenses.order(date: :desc) %>

<div class="container mx-auto px-4 py-4">
  <h1 class="text-2xl font-bold mb-4"><%= t("expenses.index.title") %></h1>

  <%= form_with url: expenses_path, method: :get, local: true, class: "flex flex-col sm:flex-row sm:items-end gap-4 flex-wrap mb-4" do |f| %>
    <div class="flex flex-wrap items-center gap-2">
      <label for="date_from" class="text-sm font-medium text-gray-700"><%= t("expenses.index.date_from") %></label>
      <%= f.date_field :date_from, value: params[:date_from], id: "date_from", class: "rounded border border-gray-300 px-3 py-2 text-sm" %>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <label for="date_to" class="text-sm font-medium text-gray-700"><%= t("expenses.index.date_to") %></label>
      <%= f.date_field :date_to, value: params[:date_to], id: "date_to", class: "rounded border border-gray-300 px-3 py-2 text-sm" %>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <label for="category_id" class="text-sm font-medium text-gray-700"><%= t("expenses.index.category") %></label>
      <%= f.select :category_id, Category.all.pluck(:name, :id), { include_blank: t("expenses.index.all_categories") }, id: "category_id", class: "rounded border border-gray-300 px-3 py-2 text-sm" %>
    </div>
    <div class="flex flex-wrap items-center gap-2 flex-grow min-w-0">
      <label for="q" class="text-sm font-medium text-gray-700 sr-only"><%= t("expenses.index.description_placeholder") %></label>
      <%= f.text_field :q, placeholder: t("expenses.index.description_placeholder"), value: params[:q], id: "q", class: "rounded border border-gray-300 px-3 py-2 text-sm flex-1 min-w-0" %>
    </div>
    <%= f.submit t("expenses.index.filter"), class: "px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm font-medium cursor-pointer w-full sm:w-auto" %>
  <% end %>

  <div class="mb-4 flex justify-between items-center">
    <div class="w-full sm:w-auto [&>a]:w-full [&>a]:sm:w-auto [&>a]:flex [&>a]:justify-center">
      <%= render AddButtonComponent.new(
        label: t("expenses.index.new_expense"),
        path: new_expense_path
      ) %>
    </div>
  </div>

  <%# Desktop: table %>
  <div class="hidden md:block overflow-x-auto">
    <table class="min-w-full bg-white border">
      <thead>
        <tr class="bg-gray-100">
          <th class="px-4 py-2 text-left"><%= t("expenses.index.date") %></th>
          <th class="px-4 py-2 text-left"><%= t("expenses.index.category") %></th>
          <th class="px-4 py-2 text-left"><%= t("expenses.index.description") %></th>
          <th class="px-4 py-2 text-left"><%= t("expenses.index.budget_period") %></th>
          <th class="px-4 py-2 text-left"><%= t("expenses.index.income_event") %></th>
          <th class="px-4 py-2 text-right"><%= t("expenses.index.amount") %></th>
          <th class="px-4 py-2 text-center"><%= t("shared.actions") %></th>
        </tr>
      </thead>
      <tbody>
        <% ordered_expenses.each do |expense| %>
          <tr class="border-t">
            <td class="px-4 py-2"><%= expense.date.strftime("%d %b %Y") %></td>
            <td class="px-4 py-2"><%= expense.category.name %></td>
            <td class="px-4 py-2"><%= expense.description %></td>
            <td class="px-4 py-2">
              <% if expense.budget_period %>
                <%= link_to expense.budget_period.name, expense.budget_period, class: "text-blue-600 hover:underline" %>
              <% else %>
                <span class="text-gray-400"><%= t("expenses.index.unassigned") %></span>
              <% end %>
            </td>
            <td class="px-4 py-2">
              <% if expense.income_event %>
                <%= link_to expense.income_event.description, expense.income_event, class: "text-purple-600 hover:underline" %>
              <% else %>
                <span class="text-gray-400"><%= t("expenses.index.unassigned") %></span>
              <% end %>
            </td>
            <td class="px-4 py-2 text-right"><%= number_to_currency(expense.amount) %></td>
            <td class="px-4 py-2 text-center">
              <span class="inline-flex items-center gap-2">
                <%= link_to t("shared.edit"), edit_expense_path(expense), class: "px-3 py-2 text-sm text-blue-600 hover:underline rounded hover:bg-blue-50 min-h-[44px] inline-flex items-center", aria: { label: "#{t('shared.edit')} #{t('expenses.index.title')}" } %>
                <%= link_to t("shared.delete"), expense, data: { turbo_method: :delete, turbo_confirm: t("expenses.index.confirm_destroy") }, class: "px-3 py-2 text-sm text-red-600 hover:underline rounded hover:bg-red-50 min-h-[44px] inline-flex items-center", aria: { label: "#{t('shared.delete')} #{t('expenses.index.title')}" } %>
              </span>
            </td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr class="bg-gray-50 font-semibold">
          <td colspan="5" class="px-4 py-2 text-right">Total:</td>
          <td class="px-4 py-2 text-right">
            <%= number_to_currency(@expenses.sum(:amount)) %>
          </td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <%# Mobile: card list %>
  <div class="md:hidden space-y-3">
    <% ordered_expenses.each do |expense| %>
      <div class="bg-white border rounded-lg p-4 shadow-sm">
        <div class="flex justify-between items-start gap-2 mb-2">
          <span class="font-semibold text-gray-900 truncate flex-1"><%= expense.description.presence || expense.category.name %></span>
          <span class="font-semibold text-gray-900 whitespace-nowrap"><%= number_to_currency(expense.amount) %></span>
        </div>
        <div class="text-sm text-gray-600 mb-1">
          <%= expense.date.strftime("%d %b %Y") %> · <%= expense.category.name %>
        </div>
        <div class="text-xs text-gray-500 mb-3">
          <%= t("expenses.index.budget_period") %>: <%= expense.budget_period ? expense.budget_period.name : t("expenses.index.unassigned") %> ·
          <%= t("expenses.index.income_event") %>: <%= expense.income_event ? expense.income_event.description : t("expenses.index.unassigned") %>
        </div>
        <div class="flex flex-wrap gap-2">
          <%= link_to t("shared.edit"), edit_expense_path(expense), class: "inline-flex items-center justify-center min-h-[44px] px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded hover:bg-blue-100", aria: { label: "#{t('shared.edit')} #{t('expenses.index.title')}" } %>
          <%= link_to t("shared.delete"), expense, data: { turbo_method: :delete, turbo_confirm: t("expenses.index.confirm_destroy") }, class: "inline-flex items-center justify-center min-h-[44px] px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded hover:bg-red-100", aria: { label: "#{t('shared.delete')} #{t('expenses.index.title')}" } %>
          <%= link_to t("shared.view"), expense, class: "inline-flex items-center justify-center min-h-[44px] px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded hover:bg-gray-200", aria: { label: "#{t('shared.view')} #{t('expenses.index.title')}" } %>
        </div>
      </div>
    <% end %>

    <% if ordered_expenses.any? %>
      <div class="bg-gray-50 border rounded-lg p-4 font-semibold flex justify-between items-center">
        <span><%= t("expenses.index.total") %>:</span>
        <span><%= number_to_currency(@expenses.sum(:amount)) %></span>
      </div>
    <% end %>
  </div>
</div>
